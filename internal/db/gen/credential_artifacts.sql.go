// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: credential_artifacts.sql

package gen

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const countCredentialArtifactsBySourceAndQueryAndFilters = `-- name: CountCredentialArtifactsBySourceAndQueryAndFilters :one
SELECT count(*)
FROM credential_artifacts ca
WHERE
  ca.source_kind = $1::text
  AND ca.source_name = $2::text
  AND ca.expired_at IS NULL
  AND ca.last_observed_run_id IS NOT NULL
  AND (
    $3::text = ''
    OR ca.credential_kind = $3::text
  )
  AND (
    $4::text = ''
    OR lower(ca.status) = lower($4::text)
  )
  AND (
    $5::text = ''
    OR lower($5::text) = (
      CASE
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source < now()
          AND lower(COALESCE(NULLIF(trim(ca.status), ''), 'active')) IN ('active', 'approved', 'pending_approval')
          THEN 'critical'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source < now()
          THEN 'high'
        WHEN lower(ca.credential_kind) IN ('entra_client_secret', 'github_deploy_key', 'github_pat_request', 'github_pat_fine_grained')
          AND trim(ca.created_by_external_id) = ''
          AND trim(ca.approved_by_external_id) = ''
          THEN 'critical'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source >= now()
          AND ca.expires_at_source <= now() + make_interval(days => 7)
          THEN 'high'
        WHEN trim(ca.created_by_external_id) = ''
          THEN 'high'
        WHEN ca.last_used_at_source IS NOT NULL
          AND ca.last_used_at_source <= now() - make_interval(days => 90)
          THEN 'high'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source >= now()
          AND ca.expires_at_source <= now() + make_interval(days => 30)
          THEN 'medium'
        ELSE 'low'
      END
    )
  )
  AND (
    $6::text = ''
    OR (
      $6::text = 'expired'
      AND ca.expires_at_source IS NOT NULL
      AND ca.expires_at_source < now()
    )
    OR (
      $6::text = 'active'
      AND (ca.expires_at_source IS NULL OR ca.expires_at_source >= now())
    )
  )
  AND (
    $7::int <= 0
    OR (
      ca.expires_at_source IS NOT NULL
      AND ca.expires_at_source >= now()
      AND ca.expires_at_source <= now() + make_interval(days => $7::int)
    )
  )
  AND (
    $8::text = ''
    OR ca.display_name ILIKE ('%' || $8::text || '%')
    OR ca.external_id ILIKE ('%' || $8::text || '%')
    OR ca.asset_ref_external_id ILIKE ('%' || $8::text || '%')
    OR ca.created_by_external_id ILIKE ('%' || $8::text || '%')
    OR ca.approved_by_external_id ILIKE ('%' || $8::text || '%')
  )
`

type CountCredentialArtifactsBySourceAndQueryAndFiltersParams struct {
	SourceKind     string `json:"source_kind"`
	SourceName     string `json:"source_name"`
	CredentialKind string `json:"credential_kind"`
	Status         string `json:"status"`
	RiskLevel      string `json:"risk_level"`
	ExpiryState    string `json:"expiry_state"`
	ExpiresInDays  int32  `json:"expires_in_days"`
	Query          string `json:"query"`
}

func (q *Queries) CountCredentialArtifactsBySourceAndQueryAndFilters(ctx context.Context, arg CountCredentialArtifactsBySourceAndQueryAndFiltersParams) (int64, error) {
	row := q.db.QueryRow(ctx, countCredentialArtifactsBySourceAndQueryAndFilters,
		arg.SourceKind,
		arg.SourceName,
		arg.CredentialKind,
		arg.Status,
		arg.RiskLevel,
		arg.ExpiryState,
		arg.ExpiresInDays,
		arg.Query,
	)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countCredentialArtifactsExpiringWithinDaysBySource = `-- name: CountCredentialArtifactsExpiringWithinDaysBySource :one
SELECT count(*)
FROM credential_artifacts ca
WHERE ca.source_kind = $1::text
  AND ca.source_name = $2::text
  AND ca.expired_at IS NULL
  AND ca.last_observed_run_id IS NOT NULL
  AND ca.expires_at_source IS NOT NULL
  AND ca.expires_at_source >= now()
  AND ca.expires_at_source <= now() + make_interval(days => $3::int)
`

type CountCredentialArtifactsExpiringWithinDaysBySourceParams struct {
	SourceKind    string `json:"source_kind"`
	SourceName    string `json:"source_name"`
	ExpiresInDays int32  `json:"expires_in_days"`
}

func (q *Queries) CountCredentialArtifactsExpiringWithinDaysBySource(ctx context.Context, arg CountCredentialArtifactsExpiringWithinDaysBySourceParams) (int64, error) {
	row := q.db.QueryRow(ctx, countCredentialArtifactsExpiringWithinDaysBySource, arg.SourceKind, arg.SourceName, arg.ExpiresInDays)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const expireCredentialArtifactsNotSeenInRunBySource = `-- name: ExpireCredentialArtifactsNotSeenInRunBySource :execrows
UPDATE credential_artifacts
SET
  expired_at = now(),
  expired_run_id = $1::bigint
WHERE source_kind = $2::text
  AND source_name = $3::text
  AND expired_at IS NULL
  AND last_observed_run_id IS NOT NULL
  AND (
    seen_in_run_id <> $1::bigint
    OR seen_in_run_id IS NULL
  )
`

type ExpireCredentialArtifactsNotSeenInRunBySourceParams struct {
	ExpiredRunID int64  `json:"expired_run_id"`
	SourceKind   string `json:"source_kind"`
	SourceName   string `json:"source_name"`
}

func (q *Queries) ExpireCredentialArtifactsNotSeenInRunBySource(ctx context.Context, arg ExpireCredentialArtifactsNotSeenInRunBySourceParams) (int64, error) {
	result, err := q.db.Exec(ctx, expireCredentialArtifactsNotSeenInRunBySource, arg.ExpiredRunID, arg.SourceKind, arg.SourceName)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}

const getCredentialArtifactByID = `-- name: GetCredentialArtifactByID :one
SELECT id, source_kind, source_name, asset_ref_kind, asset_ref_external_id, credential_kind, external_id, display_name, fingerprint, scope_json, status, created_at_source, expires_at_source, last_used_at_source, created_by_kind, created_by_external_id, created_by_display_name, approved_by_kind, approved_by_external_id, approved_by_display_name, raw_json, seen_in_run_id, seen_at, last_observed_run_id, last_observed_at, expired_at, expired_run_id, created_at, updated_at
FROM credential_artifacts
WHERE id = $1
  AND expired_at IS NULL
  AND last_observed_run_id IS NOT NULL
`

func (q *Queries) GetCredentialArtifactByID(ctx context.Context, id int64) (CredentialArtifact, error) {
	row := q.db.QueryRow(ctx, getCredentialArtifactByID, id)
	var i CredentialArtifact
	err := row.Scan(
		&i.ID,
		&i.SourceKind,
		&i.SourceName,
		&i.AssetRefKind,
		&i.AssetRefExternalID,
		&i.CredentialKind,
		&i.ExternalID,
		&i.DisplayName,
		&i.Fingerprint,
		&i.ScopeJson,
		&i.Status,
		&i.CreatedAtSource,
		&i.ExpiresAtSource,
		&i.LastUsedAtSource,
		&i.CreatedByKind,
		&i.CreatedByExternalID,
		&i.CreatedByDisplayName,
		&i.ApprovedByKind,
		&i.ApprovedByExternalID,
		&i.ApprovedByDisplayName,
		&i.RawJson,
		&i.SeenInRunID,
		&i.SeenAt,
		&i.LastObservedRunID,
		&i.LastObservedAt,
		&i.ExpiredAt,
		&i.ExpiredRunID,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listCredentialArtifactCountsByAssetRef = `-- name: ListCredentialArtifactCountsByAssetRef :many
WITH requested AS (
  SELECT
    k.asset_ref_kind::text AS asset_ref_kind,
    e.asset_ref_external_id::text AS asset_ref_external_id
  FROM unnest($3::text[]) WITH ORDINALITY AS k(asset_ref_kind, ord)
  JOIN unnest($4::text[]) WITH ORDINALITY AS e(asset_ref_external_id, ord)
    USING (ord)
)
SELECT
  r.asset_ref_kind::text AS asset_ref_kind,
  r.asset_ref_external_id::text AS asset_ref_external_id,
  count(ca.id)::bigint AS credential_count
FROM requested r
LEFT JOIN credential_artifacts ca
  ON ca.source_kind = $1::text
  AND ca.source_name = $2::text
  AND ca.asset_ref_kind = r.asset_ref_kind
  AND ca.asset_ref_external_id = r.asset_ref_external_id
  AND ca.expired_at IS NULL
  AND ca.last_observed_run_id IS NOT NULL
GROUP BY r.asset_ref_kind, r.asset_ref_external_id
ORDER BY r.asset_ref_kind, r.asset_ref_external_id
`

type ListCredentialArtifactCountsByAssetRefParams struct {
	SourceKind          string   `json:"source_kind"`
	SourceName          string   `json:"source_name"`
	AssetRefKinds       []string `json:"asset_ref_kinds"`
	AssetRefExternalIds []string `json:"asset_ref_external_ids"`
}

type ListCredentialArtifactCountsByAssetRefRow struct {
	AssetRefKind       string `json:"asset_ref_kind"`
	AssetRefExternalID string `json:"asset_ref_external_id"`
	CredentialCount    int64  `json:"credential_count"`
}

func (q *Queries) ListCredentialArtifactCountsByAssetRef(ctx context.Context, arg ListCredentialArtifactCountsByAssetRefParams) ([]ListCredentialArtifactCountsByAssetRefRow, error) {
	rows, err := q.db.Query(ctx, listCredentialArtifactCountsByAssetRef,
		arg.SourceKind,
		arg.SourceName,
		arg.AssetRefKinds,
		arg.AssetRefExternalIds,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ListCredentialArtifactCountsByAssetRefRow
	for rows.Next() {
		var i ListCredentialArtifactCountsByAssetRefRow
		if err := rows.Scan(&i.AssetRefKind, &i.AssetRefExternalID, &i.CredentialCount); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listCredentialArtifactsByIDs = `-- name: ListCredentialArtifactsByIDs :many
SELECT id, source_kind, source_name, asset_ref_kind, asset_ref_external_id, credential_kind, external_id, display_name, fingerprint, scope_json, status, created_at_source, expires_at_source, last_used_at_source, created_by_kind, created_by_external_id, created_by_display_name, approved_by_kind, approved_by_external_id, approved_by_display_name, raw_json, seen_in_run_id, seen_at, last_observed_run_id, last_observed_at, expired_at, expired_run_id, created_at, updated_at
FROM credential_artifacts
WHERE id = ANY($1::bigint[])
  AND expired_at IS NULL
  AND last_observed_run_id IS NOT NULL
ORDER BY id ASC
`

func (q *Queries) ListCredentialArtifactsByIDs(ctx context.Context, credentialIds []int64) ([]CredentialArtifact, error) {
	rows, err := q.db.Query(ctx, listCredentialArtifactsByIDs, credentialIds)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []CredentialArtifact
	for rows.Next() {
		var i CredentialArtifact
		if err := rows.Scan(
			&i.ID,
			&i.SourceKind,
			&i.SourceName,
			&i.AssetRefKind,
			&i.AssetRefExternalID,
			&i.CredentialKind,
			&i.ExternalID,
			&i.DisplayName,
			&i.Fingerprint,
			&i.ScopeJson,
			&i.Status,
			&i.CreatedAtSource,
			&i.ExpiresAtSource,
			&i.LastUsedAtSource,
			&i.CreatedByKind,
			&i.CreatedByExternalID,
			&i.CreatedByDisplayName,
			&i.ApprovedByKind,
			&i.ApprovedByExternalID,
			&i.ApprovedByDisplayName,
			&i.RawJson,
			&i.SeenInRunID,
			&i.SeenAt,
			&i.LastObservedRunID,
			&i.LastObservedAt,
			&i.ExpiredAt,
			&i.ExpiredRunID,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listCredentialArtifactsForAssetRef = `-- name: ListCredentialArtifactsForAssetRef :many
SELECT ca.id, ca.source_kind, ca.source_name, ca.asset_ref_kind, ca.asset_ref_external_id, ca.credential_kind, ca.external_id, ca.display_name, ca.fingerprint, ca.scope_json, ca.status, ca.created_at_source, ca.expires_at_source, ca.last_used_at_source, ca.created_by_kind, ca.created_by_external_id, ca.created_by_display_name, ca.approved_by_kind, ca.approved_by_external_id, ca.approved_by_display_name, ca.raw_json, ca.seen_in_run_id, ca.seen_at, ca.last_observed_run_id, ca.last_observed_at, ca.expired_at, ca.expired_run_id, ca.created_at, ca.updated_at
FROM credential_artifacts ca
WHERE ca.source_kind = $1::text
  AND ca.source_name = $2::text
  AND ca.asset_ref_kind = $3::text
  AND ca.asset_ref_external_id = $4::text
  AND ca.expired_at IS NULL
  AND ca.last_observed_run_id IS NOT NULL
ORDER BY
  COALESCE(ca.expires_at_source, 'infinity'::timestamptz) ASC,
  ca.id ASC
`

type ListCredentialArtifactsForAssetRefParams struct {
	SourceKind         string `json:"source_kind"`
	SourceName         string `json:"source_name"`
	AssetRefKind       string `json:"asset_ref_kind"`
	AssetRefExternalID string `json:"asset_ref_external_id"`
}

func (q *Queries) ListCredentialArtifactsForAssetRef(ctx context.Context, arg ListCredentialArtifactsForAssetRefParams) ([]CredentialArtifact, error) {
	rows, err := q.db.Query(ctx, listCredentialArtifactsForAssetRef,
		arg.SourceKind,
		arg.SourceName,
		arg.AssetRefKind,
		arg.AssetRefExternalID,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []CredentialArtifact
	for rows.Next() {
		var i CredentialArtifact
		if err := rows.Scan(
			&i.ID,
			&i.SourceKind,
			&i.SourceName,
			&i.AssetRefKind,
			&i.AssetRefExternalID,
			&i.CredentialKind,
			&i.ExternalID,
			&i.DisplayName,
			&i.Fingerprint,
			&i.ScopeJson,
			&i.Status,
			&i.CreatedAtSource,
			&i.ExpiresAtSource,
			&i.LastUsedAtSource,
			&i.CreatedByKind,
			&i.CreatedByExternalID,
			&i.CreatedByDisplayName,
			&i.ApprovedByKind,
			&i.ApprovedByExternalID,
			&i.ApprovedByDisplayName,
			&i.RawJson,
			&i.SeenInRunID,
			&i.SeenAt,
			&i.LastObservedRunID,
			&i.LastObservedAt,
			&i.ExpiredAt,
			&i.ExpiredRunID,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listCredentialArtifactsPageBySourceAndQueryAndFilters = `-- name: ListCredentialArtifactsPageBySourceAndQueryAndFilters :many
SELECT ca.id, ca.source_kind, ca.source_name, ca.asset_ref_kind, ca.asset_ref_external_id, ca.credential_kind, ca.external_id, ca.display_name, ca.fingerprint, ca.scope_json, ca.status, ca.created_at_source, ca.expires_at_source, ca.last_used_at_source, ca.created_by_kind, ca.created_by_external_id, ca.created_by_display_name, ca.approved_by_kind, ca.approved_by_external_id, ca.approved_by_display_name, ca.raw_json, ca.seen_in_run_id, ca.seen_at, ca.last_observed_run_id, ca.last_observed_at, ca.expired_at, ca.expired_run_id, ca.created_at, ca.updated_at
FROM credential_artifacts ca
WHERE
  ca.source_kind = $1::text
  AND ca.source_name = $2::text
  AND ca.expired_at IS NULL
  AND ca.last_observed_run_id IS NOT NULL
  AND (
    $3::text = ''
    OR ca.credential_kind = $3::text
  )
  AND (
    $4::text = ''
    OR lower(ca.status) = lower($4::text)
  )
  AND (
    $5::text = ''
    OR lower($5::text) = (
      CASE
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source < now()
          AND lower(COALESCE(NULLIF(trim(ca.status), ''), 'active')) IN ('active', 'approved', 'pending_approval')
          THEN 'critical'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source < now()
          THEN 'high'
        WHEN lower(ca.credential_kind) IN ('entra_client_secret', 'github_deploy_key', 'github_pat_request', 'github_pat_fine_grained')
          AND trim(ca.created_by_external_id) = ''
          AND trim(ca.approved_by_external_id) = ''
          THEN 'critical'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source >= now()
          AND ca.expires_at_source <= now() + make_interval(days => 7)
          THEN 'high'
        WHEN trim(ca.created_by_external_id) = ''
          THEN 'high'
        WHEN ca.last_used_at_source IS NOT NULL
          AND ca.last_used_at_source <= now() - make_interval(days => 90)
          THEN 'high'
        WHEN ca.expires_at_source IS NOT NULL
          AND ca.expires_at_source >= now()
          AND ca.expires_at_source <= now() + make_interval(days => 30)
          THEN 'medium'
        ELSE 'low'
      END
    )
  )
  AND (
    $6::text = ''
    OR (
      $6::text = 'expired'
      AND ca.expires_at_source IS NOT NULL
      AND ca.expires_at_source < now()
    )
    OR (
      $6::text = 'active'
      AND (ca.expires_at_source IS NULL OR ca.expires_at_source >= now())
    )
  )
  AND (
    $7::int <= 0
    OR (
      ca.expires_at_source IS NOT NULL
      AND ca.expires_at_source >= now()
      AND ca.expires_at_source <= now() + make_interval(days => $7::int)
    )
  )
  AND (
    $8::text = ''
    OR ca.display_name ILIKE ('%' || $8::text || '%')
    OR ca.external_id ILIKE ('%' || $8::text || '%')
    OR ca.asset_ref_external_id ILIKE ('%' || $8::text || '%')
    OR ca.created_by_external_id ILIKE ('%' || $8::text || '%')
    OR ca.approved_by_external_id ILIKE ('%' || $8::text || '%')
  )
ORDER BY
  COALESCE(ca.expires_at_source, 'infinity'::timestamptz) ASC,
  lower(COALESCE(NULLIF(trim(ca.display_name), ''), ca.external_id)) ASC,
  ca.id ASC
LIMIT $10::int
OFFSET $9::int
`

type ListCredentialArtifactsPageBySourceAndQueryAndFiltersParams struct {
	SourceKind     string `json:"source_kind"`
	SourceName     string `json:"source_name"`
	CredentialKind string `json:"credential_kind"`
	Status         string `json:"status"`
	RiskLevel      string `json:"risk_level"`
	ExpiryState    string `json:"expiry_state"`
	ExpiresInDays  int32  `json:"expires_in_days"`
	Query          string `json:"query"`
	PageOffset     int32  `json:"page_offset"`
	PageLimit      int32  `json:"page_limit"`
}

func (q *Queries) ListCredentialArtifactsPageBySourceAndQueryAndFilters(ctx context.Context, arg ListCredentialArtifactsPageBySourceAndQueryAndFiltersParams) ([]CredentialArtifact, error) {
	rows, err := q.db.Query(ctx, listCredentialArtifactsPageBySourceAndQueryAndFilters,
		arg.SourceKind,
		arg.SourceName,
		arg.CredentialKind,
		arg.Status,
		arg.RiskLevel,
		arg.ExpiryState,
		arg.ExpiresInDays,
		arg.Query,
		arg.PageOffset,
		arg.PageLimit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []CredentialArtifact
	for rows.Next() {
		var i CredentialArtifact
		if err := rows.Scan(
			&i.ID,
			&i.SourceKind,
			&i.SourceName,
			&i.AssetRefKind,
			&i.AssetRefExternalID,
			&i.CredentialKind,
			&i.ExternalID,
			&i.DisplayName,
			&i.Fingerprint,
			&i.ScopeJson,
			&i.Status,
			&i.CreatedAtSource,
			&i.ExpiresAtSource,
			&i.LastUsedAtSource,
			&i.CreatedByKind,
			&i.CreatedByExternalID,
			&i.CreatedByDisplayName,
			&i.ApprovedByKind,
			&i.ApprovedByExternalID,
			&i.ApprovedByDisplayName,
			&i.RawJson,
			&i.SeenInRunID,
			&i.SeenAt,
			&i.LastObservedRunID,
			&i.LastObservedAt,
			&i.ExpiredAt,
			&i.ExpiredRunID,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const promoteCredentialArtifactsSeenInRunBySource = `-- name: PromoteCredentialArtifactsSeenInRunBySource :execrows
UPDATE credential_artifacts
SET
  last_observed_run_id = $1::bigint,
  last_observed_at = now(),
  expired_at = NULL,
  expired_run_id = NULL
WHERE source_kind = $2::text
  AND source_name = $3::text
  AND seen_in_run_id = $1::bigint
`

type PromoteCredentialArtifactsSeenInRunBySourceParams struct {
	LastObservedRunID int64  `json:"last_observed_run_id"`
	SourceKind        string `json:"source_kind"`
	SourceName        string `json:"source_name"`
}

func (q *Queries) PromoteCredentialArtifactsSeenInRunBySource(ctx context.Context, arg PromoteCredentialArtifactsSeenInRunBySourceParams) (int64, error) {
	result, err := q.db.Exec(ctx, promoteCredentialArtifactsSeenInRunBySource, arg.LastObservedRunID, arg.SourceKind, arg.SourceName)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}

const upsertCredentialArtifactsBulkBySource = `-- name: UpsertCredentialArtifactsBulkBySource :execrows
WITH input AS (
  SELECT
    i,
    ($4::text[])[i] AS asset_ref_kind,
    ($5::text[])[i] AS asset_ref_external_id,
    ($6::text[])[i] AS credential_kind,
    ($7::text[])[i] AS external_id,
    ($8::text[])[i] AS display_name,
    ($9::text[])[i] AS fingerprint,
    ($10::jsonb[])[i] AS scope_json,
    ($11::text[])[i] AS status,
    ($12::timestamptz[])[i] AS created_at_source,
    ($13::timestamptz[])[i] AS expires_at_source,
    ($14::timestamptz[])[i] AS last_used_at_source,
    ($15::text[])[i] AS created_by_kind,
    ($16::text[])[i] AS created_by_external_id,
    ($17::text[])[i] AS created_by_display_name,
    ($18::text[])[i] AS approved_by_kind,
    ($19::text[])[i] AS approved_by_external_id,
    ($20::text[])[i] AS approved_by_display_name,
    ($21::jsonb[])[i] AS raw_json
  FROM generate_subscripts($7::text[], 1) AS s(i)
),
dedup AS (
  SELECT DISTINCT ON (asset_ref_kind, asset_ref_external_id, credential_kind, external_id)
    asset_ref_kind,
    asset_ref_external_id,
    credential_kind,
    external_id,
    display_name,
    fingerprint,
    scope_json,
    status,
    created_at_source,
    expires_at_source,
    last_used_at_source,
    created_by_kind,
    created_by_external_id,
    created_by_display_name,
    approved_by_kind,
    approved_by_external_id,
    approved_by_display_name,
    raw_json
  FROM input
  ORDER BY asset_ref_kind, asset_ref_external_id, credential_kind, external_id, i DESC
)
INSERT INTO credential_artifacts (
  source_kind,
  source_name,
  asset_ref_kind,
  asset_ref_external_id,
  credential_kind,
  external_id,
  display_name,
  fingerprint,
  scope_json,
  status,
  created_at_source,
  expires_at_source,
  last_used_at_source,
  created_by_kind,
  created_by_external_id,
  created_by_display_name,
  approved_by_kind,
  approved_by_external_id,
  approved_by_display_name,
  raw_json,
  seen_in_run_id,
  seen_at,
  updated_at
)
SELECT
  $1::text,
  $2::text,
  input.asset_ref_kind,
  input.asset_ref_external_id,
  input.credential_kind,
  input.external_id,
  input.display_name,
  input.fingerprint,
  input.scope_json,
  input.status,
  input.created_at_source,
  input.expires_at_source,
  input.last_used_at_source,
  input.created_by_kind,
  input.created_by_external_id,
  input.created_by_display_name,
  input.approved_by_kind,
  input.approved_by_external_id,
  input.approved_by_display_name,
  input.raw_json,
  $3::bigint,
  now(),
  now()
FROM dedup input
ON CONFLICT (source_kind, source_name, credential_kind, external_id, asset_ref_kind, asset_ref_external_id) DO UPDATE SET
  display_name = EXCLUDED.display_name,
  fingerprint = EXCLUDED.fingerprint,
  scope_json = EXCLUDED.scope_json,
  status = EXCLUDED.status,
  created_at_source = COALESCE(EXCLUDED.created_at_source, credential_artifacts.created_at_source),
  expires_at_source = COALESCE(EXCLUDED.expires_at_source, credential_artifacts.expires_at_source),
  last_used_at_source = COALESCE(EXCLUDED.last_used_at_source, credential_artifacts.last_used_at_source),
  created_by_kind = COALESCE(NULLIF(EXCLUDED.created_by_kind, ''), credential_artifacts.created_by_kind),
  created_by_external_id = COALESCE(NULLIF(EXCLUDED.created_by_external_id, ''), credential_artifacts.created_by_external_id),
  created_by_display_name = COALESCE(NULLIF(EXCLUDED.created_by_display_name, ''), credential_artifacts.created_by_display_name),
  approved_by_kind = COALESCE(NULLIF(EXCLUDED.approved_by_kind, ''), credential_artifacts.approved_by_kind),
  approved_by_external_id = COALESCE(NULLIF(EXCLUDED.approved_by_external_id, ''), credential_artifacts.approved_by_external_id),
  approved_by_display_name = COALESCE(NULLIF(EXCLUDED.approved_by_display_name, ''), credential_artifacts.approved_by_display_name),
  raw_json = EXCLUDED.raw_json,
  seen_in_run_id = EXCLUDED.seen_in_run_id,
  seen_at = EXCLUDED.seen_at,
  updated_at = now()
`

type UpsertCredentialArtifactsBulkBySourceParams struct {
	SourceKind             string               `json:"source_kind"`
	SourceName             string               `json:"source_name"`
	SeenInRunID            int64                `json:"seen_in_run_id"`
	AssetRefKinds          []string             `json:"asset_ref_kinds"`
	AssetRefExternalIds    []string             `json:"asset_ref_external_ids"`
	CredentialKinds        []string             `json:"credential_kinds"`
	ExternalIds            []string             `json:"external_ids"`
	DisplayNames           []string             `json:"display_names"`
	Fingerprints           []string             `json:"fingerprints"`
	ScopeJsons             [][]byte             `json:"scope_jsons"`
	Statuses               []string             `json:"statuses"`
	CreatedAtSources       []pgtype.Timestamptz `json:"created_at_sources"`
	ExpiresAtSources       []pgtype.Timestamptz `json:"expires_at_sources"`
	LastUsedAtSources      []pgtype.Timestamptz `json:"last_used_at_sources"`
	CreatedByKinds         []string             `json:"created_by_kinds"`
	CreatedByExternalIds   []string             `json:"created_by_external_ids"`
	CreatedByDisplayNames  []string             `json:"created_by_display_names"`
	ApprovedByKinds        []string             `json:"approved_by_kinds"`
	ApprovedByExternalIds  []string             `json:"approved_by_external_ids"`
	ApprovedByDisplayNames []string             `json:"approved_by_display_names"`
	RawJsons               [][]byte             `json:"raw_jsons"`
}

func (q *Queries) UpsertCredentialArtifactsBulkBySource(ctx context.Context, arg UpsertCredentialArtifactsBulkBySourceParams) (int64, error) {
	result, err := q.db.Exec(ctx, upsertCredentialArtifactsBulkBySource,
		arg.SourceKind,
		arg.SourceName,
		arg.SeenInRunID,
		arg.AssetRefKinds,
		arg.AssetRefExternalIds,
		arg.CredentialKinds,
		arg.ExternalIds,
		arg.DisplayNames,
		arg.Fingerprints,
		arg.ScopeJsons,
		arg.Statuses,
		arg.CreatedAtSources,
		arg.ExpiresAtSources,
		arg.LastUsedAtSources,
		arg.CreatedByKinds,
		arg.CreatedByExternalIds,
		arg.CreatedByDisplayNames,
		arg.ApprovedByKinds,
		arg.ApprovedByExternalIds,
		arg.ApprovedByDisplayNames,
		arg.RawJsons,
	)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}
