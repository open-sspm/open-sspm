name: Publish release artifacts

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag (e.g. v0.1.2)
        required: true

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Parse version
        id: version
        run: |
          tag="${{ env.RELEASE_TAG }}"
          version="${tag}"
          version="${version#v}"
          version="${version#V}"
          version="${version#.}"

          if [[ "${tag}" == v.* || "${tag}" == V.* ]]; then
            echo "::warning::Release tag '${tag}' starts with 'v.'; normalizing to version '${version}'. Prefer tags like 'v0.1.2'."
          fi

          if [[ -z "${version}" || "${version}" == .* ]]; then
            echo "::error::Invalid version parsed from release tag '${tag}' (got '${version}'). Use tags like 'v0.1.2'."
            exit 1
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.x"
          cache: true

      - name: Test
        run: go test ./...

      - name: Setup QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image (multi-arch)
        id: docker_build
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ghcr.io/open-sspm/open-sspm:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4

      - name: Helm lint
        run: helm lint ./helm/open-sspm --set database.existingSecret.name=dummy

      - name: Helm registry login
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Package chart
        run: |
          mkdir -p dist
          helm package ./helm/open-sspm \
            --version "${{ steps.version.outputs.version }}" \
            --app-version "${{ steps.version.outputs.version }}" \
            --destination dist

      - name: Push chart (OCI)
        run: helm push "dist/open-sspm-${{ steps.version.outputs.version }}.tgz" oci://ghcr.io/open-sspm/charts

      - name: Checksums
        run: |
          sha256sum "dist/open-sspm-${{ steps.version.outputs.version }}.tgz" > dist/checksums.txt

      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            dist/open-sspm-${{ steps.version.outputs.version }}.tgz
            dist/checksums.txt

      - name: Update release notes
        uses: actions/github-script@v7
        env:
          TAG_NAME: ${{ steps.version.outputs.tag }}
          VERSION: ${{ steps.version.outputs.version }}
          IMAGE: ghcr.io/open-sspm/open-sspm:${{ steps.version.outputs.version }}
          IMAGE_DIGEST: ${{ steps.docker_build.outputs.digest }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const tag = process.env.TAG_NAME;
            const version = process.env.VERSION;
            const image = process.env.IMAGE;
            const imageDigest = process.env.IMAGE_DIGEST;

            let release = context.payload.release;
            if (!release) {
              const byTag = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              release = byTag.data;
            }

            const notes = await github.rest.repos.generateReleaseNotes({
              owner,
              repo,
              tag_name: tag,
              target_commitish: release.target_commitish,
            });

            const artifactsLines = [
              `- Container image: \`${image}\`${imageDigest ? ` (digest: \`${imageDigest}\`)` : ""}`,
              `- Helm chart (OCI): \`oci://ghcr.io/open-sspm/charts/open-sspm\` (version \`${version}\`)`,
              `- Helm chart archive: \`open-sspm-${version}.tgz\` (attached to this release)`,
              `- Checksums: \`checksums.txt\` (attached to this release)`,
            ].join("\n");

            const generatedStart = "<!-- open-sspm:generated:start -->";
            const generatedEnd = "<!-- open-sspm:generated:end -->";
            const artifactsStart = "<!-- open-sspm:artifacts:start -->";
            const artifactsEnd = "<!-- open-sspm:artifacts:end -->";

            const generatedSection = `${generatedStart}\n${notes.data.body}\n${generatedEnd}`;
            const artifactsSection = `${artifactsStart}\n## Artifacts\n${artifactsLines}\n${artifactsEnd}`;

            const stripSection = (body, start, end) => {
              const pattern = new RegExp(`${start}[\\s\\S]*?${end}\\n?`, "g");
              return body.replace(pattern, "").trim();
            };

            let body = release.body || "";
            body = stripSection(body, generatedStart, generatedEnd);
            body = stripSection(body, artifactsStart, artifactsEnd);

            const newBody = [body, generatedSection, artifactsSection]
              .filter((s) => s && s.trim())
              .join("\n\n");

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: newBody,
            });
